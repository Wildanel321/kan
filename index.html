<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>SEJARAH MULTIPLAYER HP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/confetti-js@0.0.18/dist/confetti.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Poppins:wght@600;800&display=swap');
    * { touch-action: manipulation; }
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%); margin:0; padding:0; overflow-x:hidden; }
    #app { max-width: 100vw; padding: 1rem; box-sizing: border-box; }
    input, button { font-size: 1.2rem !important; padding: 1rem !important; border-radius: 1rem !important; }
    .buzzer-btn { 
      position: fixed !important; 
      bottom: 20px; left: 50%; transform: translateX(-50%);
      width: 90vw; height: 200px; font-size: 4rem !important; 
      animation: pulse 1.2s infinite; z-index: 9999;
    }
    @keyframes pulse { 0%,100% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.05); } }
    .leaderboard { max-height: 40vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .chat-container { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 1rem; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
    .chat-box { max-height: 200px; overflow-y: auto; margin-bottom: 0.5rem; }
  </style>
</head>
<body class="min-h-screen">
  <div id="app" class="bg-white rounded-3xl shadow-2xl">
    <!-- JOIN SCREEN -->
    <div id="joinScreen" class="p-8 text-center">
      <h1 class="text-5xl font-bold mb-8 text-purple-700" style="font-family: 'Fredoka One'">SEJARAH KUY!</h1>
      <input type="text" id="playerName" placeholder="Nama kamu" class="w-full mb-5 border-4 border-purple-400" autocomplete="off"/>
      <input type="text" id="roomCode" placeholder="Kode room" class="w-full mb-8 border-4 border-purple-400" autocomplete="off"/>
      <div class="grid grid-cols-2 gap-4">
        <button onclick="createRoom()" class="bg-green-500 hover:bg-green-600 text-white font-bold text-2xl">BUAT ROOM</button>
        <button onclick="joinRoom()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold text-2xl">MASUK</button>
      </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="gameScreen" class="hidden pb-32">
      <div class="text-center mb-4">
        <h2 class="text-3xl font-bold">Room: <span id="currentRoom" class="text-purple-600"></span></h2>
        <p class="text-5xl mt-2">Skor: <span id="myScore" class="text-green-600 font-bold">0</span></p>
      </div>

      <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-3xl p-8 mb-6 text-white">
        <p class="text-2xl font-bold" id="questionText">Menunggu host...</p>
      </div>

      <button id="buzzerBtn" class="hidden buzzer-btn bg-red-600 text-white font-bold rounded-full shadow-2xl" onclick="buzzer()">
        BUZZ! ⚡
      </button>

      <!-- LEADERBOARD -->
      <div class="bg-gray-100 rounded-2xl p-4 mb-4 leaderboard">
        <h3 class="text-2xl font-bold text-center mb-3">KLASMEN</h3>
        <div id="leaderboard" class="space-y-3"></div>
      </div>
    </div>

    <!-- CHAT FIXED BOTTOM -->
    <div class="chat-container hidden" id="chatContainer">
      <div class="chat-box bg-gray-50 rounded-xl p-3" id="chat"></div>
      <div class="flex gap-2">
        <input type="text" id="chatInput" placeholder="Ketik pesan..." class="flex-1 border-2 border-purple-400 rounded-xl px-4" onkeypress="if(event.key==='Enter') sendChat()"/>
        <button onclick="sendChat()" class="bg-purple-600 text-white px-6 rounded-xl">KIRIM</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase config (sama kayak sebelumnya)
    const firebaseConfig = {
      apiKey: "AIzaSyDW1fB1a2b3c4d5e6f7g8h9i0j1k2l3m4n",
      authDomain: "sejarah-multiplayer.firebaseapp.com",
      databaseURL: "https://sejarah-multiplayer-default-rtdb.firebaseio.com",
      projectId: "sejarah-multiplayer",
      storageBucket: "sejarah-multiplayer.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdef123456"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let playerName = "", roomCode = "", playerId = "", isHost = false;

    const questions = [
      { q: "Siapa proklamator kemerdekaan Indonesia?", a: "Soekarno" },
      { q: "Kapan Sumpah Pemuda?", a: "28 Oktober 1928" },
      { q: "Perang Diponegoro tahun?", a: "1825-1830" },
      { q: "Pendiri NU?", a: "KH Hasyim Asy'ari" },
      { q: "Kapan KAA Bandung?", a: "1955" },
      { q: "Peristiwa Rengasdengklok?", a: "16 Agustus 1945" },
      { q: "Siapa pencetus Pancasila?", a: "Soekarno" },
      { q: "VOC berdiri tahun?", a: "1602" },
      { q: "Perang Padri dipimpin siapa?", a: "Tuanku Imam Bonjol" },
      { q: "Supersemar tanggal berapa?", a: "11 Maret 1966" }
    ];

    function createRoom() {
      playerName = document.getElementById("playerName").value.trim();
      if (!playerName) return alert("Isi nama dulu!");
      roomCode = "KELAS" + Math.floor(100 + Math.random() * 900);
      isHost = true;
      joinGame();
    }

    function joinRoom() {
      playerName = document.getElementById("playerName").value.trim();
      roomCode = document.getElementById("roomCode").value.trim().toUpperCase();
      if (!playerName || !roomCode) return alert("Lengkapi dulu!");
      joinGame();
    }

    function joinGame() {
      document.getElementById("joinScreen").classList.add("hidden");
      document.getElementById("gameScreen").classList.remove("hidden");
      document.getElementById("chatContainer").classList.remove("hidden");
      document.getElementById("currentRoom").textContent = roomCode;

      playerId = Date.now() + Math.random();
      db.ref(`rooms/${roomCode}/players/${playerId}`).set({
        name: playerName, score: 0, buzzer: false
      });

      if (isHost) {
        db.ref(`rooms/${roomCode}`).set({
          host: playerId,
          currentQuestion: 0,
          gameStarted: false,
          questionIndex: 0
        });
        setTimeout(() => {
          if(confirm("Mulai game sekarang?")) {
            nextQuestion();
          }
        }, 2000);
      }

      listenToGame();
    }

    function nextQuestion() {
      const idx = (db.ref(`rooms/${roomCode}/questionIndex`).once("value").then(s => s.val() || 0)) + 1;
      db.ref(`rooms/${roomCode}`).update({
        gameStarted: true,
        currentQuestion: questions[idx % questions.length].q,
        questionIndex: idx % questions.length,
        buzzerPressed: false
      });
    }

    function listenToGame() {
      db.ref(`rooms/${roomCode}`).on("value", snap => {
        const data = snap.val();
        if (!data) return;
        if (data.currentQuestion) {
          document.getElementById("questionText").textContent = data.currentQuestion;
          document.getElementById("buzzerBtn").classList.remove("hidden");
        }
        updateLeaderboard(data.players || {});
      });
    }

    function buzzer() {
      db.ref(`rooms/${roomCode}/players/${playerId}`).update({ buzzer: true });
      db.ref(`rooms/${roomCode}`).update({ buzzerWinner: playerName });
      document.getElementById("buzzerBtn").textContent = "KAMU DAPET! +50";
      document.getElementById("buzzerBtn").disabled = true;
      setTimeout(() => {
        const score = (parseInt(document.getElementById("myScore").textContent) || 0) + 50;
        db.ref(`rooms/${roomCode}/players/${playerId}`).update({ score });
        if (isHost) setTimeout(nextQuestion, 3000);
      }, 1000);
    }

    function updateLeaderboard(players) {
      const lb = document.getElementById("leaderboard");
      lb.innerHTML = "";
      const sorted = Object.entries(players || {}).sort((a, b) => b[1].score - a[1].score);
      sorted.forEach(([id, p], i) => {
        const div = document.createElement("div");
        div.className = "bg-white rounded-xl p-4 shadow flex justify-between items-center text-xl";
        div.innerHTML = `
          <span class="font-bold">${i+1}. ${p.name} ${p.buzzer ? "⚡" : ""}</span>
          <span class="font-bold text-purple-600">${p.score} poin</span>
        `;
        lb.appendChild(div);
        if (p.name === playerName) {
          document.getElementById("myScore").textContent = p.score;
        }
      });
    }

    function sendChat() {
      const msg = document.getElementById("chatInput").value.trim();
      if (!msg) return;
      db.ref(`rooms/${roomCode}/chat`).push({
        name: playerName,
        msg: msg,
        time: Date.now()
      });
      document.getElementById("chatInput").value = "";
    }

    db.ref(`rooms/${roomCode}/chat`).on("child_added", snap => {
      const chat = document.getElementById("chat");
      const div = document.createElement("div");
      div.className = "text-sm bg-gray-200 rounded px-3 py-2 mb-1";
      div.textContent = `${snap.val().name}: ${snap.val().msg}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    });
  </script>
</body>
</html>
